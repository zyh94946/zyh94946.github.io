<!DOCTYPE html><html lang="zh-CN"><head><meta charset="utf-8"><meta http-equiv="X-UA-Compatible" content="IE=edge"><meta name="viewport" content="width=device-width,initial-scale=1,maximum-scale=1"><meta name="theme-color" content="#000000"><meta name="msapplication-TileColor" content="#000000"><script>window.ga_tid="UA-146915508-1",window.ga_url="https://ga.ibelieving.io"</script><script async src="/js/ga.min.js"></script><title>用 Consul 和 Traefik 实现 Docker 容器的服务注册与发现 | ibelieving.io - 技术分享 - 行者无疆</title><meta name="keywords" content="微服务, 服务网格, 架构设计, PHP, Golang, Linux"><link rel="apple-touch-icon" sizes="180x180" href="/favicons/apple-touch-icon.png"><link rel="icon" type="image/png" sizes="192x192" href="/favicons/android-chrome-192x192.png"><link rel="icon" type="image/png" sizes="32x32" href="/favicons/favicon-32x32.png"><link rel="icon" type="image/png" sizes="16x16" href="/favicons/favicon-16x16.png"><link rel="mask-icon" href="/favicons/safari-pinned-tab.svg" color="#000000"><meta name="msapplication-config" content="/favicons/browserconfig.xml"><link rel="alternate" href="/atom.xml" title="ibelieving.io - 技术分享" type="application/atom+xml"><link rel="shortcut icon" type="image/x-icon" href="/favicons/favicon.ico"><link rel="stylesheet" href="/css/normalize.css"><link rel="stylesheet" href="/css/index.css"><link rel="stylesheet" href="/css/sidebar.css"><link rel="stylesheet" href="/css/page.css"><link rel="stylesheet" href="/css/post.css"><link rel="stylesheet" href="/css/custom.css"><link rel="stylesheet" href="/css/atom-one-dark.css"><link rel="stylesheet" href="/css/lightgallery.min.css"><script src="/js/jquery.min.js"></script><script defer src="/js/util.js"></script><script defer src="/js/clipboard.min.js"></script><script defer src="/js/scrollspy.js"></script><script defer src="/js/fontawesome-all.min.js"></script><script defer src="/js/lightgallery.min.js"></script><script defer src="/js/lg-fullscreen.min.js"></script><script defer src="/js/lg-hash.min.js"></script><script defer src="/js/lg-pager.min.js"></script><script defer src="/js/lg-thumbnail.min.js"></script><script defer src="/js/lg-zoom.min.js"></script><script defer src="/js/busuanzi.pure.mini.js"></script><script defer src="/js/search.js"></script><script>$(document).ready(function(){var e="search.xml";0===e.length&&(e="search.xml"),searchFunc("/"+e,"search-input","search-result")})</script><script defer src="/js/index.js"></script><script>$(document).ready(function(){var t=$(".post figure.highlight");(t.length?($(t).each(function(t,n){$(n).before('<button class="copy button">复制</button>')}),new ClipboardJS("button.copy",{target:function(t){return t.nextElementSibling.firstChild.firstChild.firstChild.lastChild.firstChild.firstChild}})):(t=$(".post pre code"),$(t).each(function(t,n){$(n).parent().before('<button class="copy button">复制</button>')}),new ClipboardJS("button.copy",{target:function(t){return t.nextElementSibling.firstChild}}))).on("success",function(t){t.clearSelection();var n=t.trigger;n.innerHTML="已复制",$(n).addClass("copied"),setTimeout(function(){n.innerHTML="复制",$(n).removeClass("copied")},1500)})})</script><script defer src="/js/custom.js"></script><meta name="generator" content="Hexo 4.2.1"></head><body itemscope itemtype="https://schema.org/WebPage" lang="zh-CN" data-spy="scroll" data-target=".list-group"><header id="header" class="header" style="background-color:#000"><div class="container"><div class="header-container"><div class="header-title"><h1 class="title"><a href="/">ibelieving.io - 技术分享</a></h1><h2 class="subtitle">行者无疆</h2></div></div><nav id="nav" class="nav"><a id="nav-toggle" class="nav-toggle" aria-hidden="true"><i class="fas fa-bars" aria-label="切换导航栏"></i></a><ul id="menu" role="menubar" aria-hidden="false"><li role="menuitem"><a href="/"><i class="fas fa-home"></i><span class="menu-text">首页</span></a></li><li role="menuitem"><a href="/archives/"><i class="fas fa-archive"></i><span class="menu-text">归档</span></a></li></ul></nav></div></header><main id="main" class="main"><div class="container"><div class="main-container"><div class="content"><div id="post" class="page"><article class="article post card" itemscope itemtype="https://schema.org/Article"><div class="post-block"><link itemprop="mainEntityOfPage" href="https://ibelieving.io/2020/02/06/consul_and_traefik_micro_service/"><span hidden itemprop="author" itemscope itemtype="https://schema.org/Person"><meta itemprop="name" content="Zhongyang Hao"><meta itemprop="description" content="技术分享，包括不限于微服务、服务网格。主要开发语言PHP、Golang。"><meta itemprop="image" content="/images/avatar.gif"></span><span hidden itemprop="publisher" itemscope itemtype="https://schema.org/Organization"><meta itemprop="name" content="ibelieving.io - 技术分享"></span></div><header class="post-header"><h1 class="post-title" itemprop="name headline">用 Consul 和 Traefik 实现 Docker 容器的服务注册与发现</h1><div class="post-meta"><span class="post-date"><i class="far fa-calendar-plus"></i><span><time title="post-date" itemprop="dateCreated datePublished" datetime="2020-02-06T22:43:52+08:00">2020-02-06 晚上</time></span></span></div></header><main class="post-main" itemprop="articleBody"><p>docker 实现应用的容器化<br>consul 集群实现服务的注册、发现<br>traefik 处理外部流量的负载均衡与路由</p><h2 id="启动-consul-集群与-docker"><a href="#启动-consul-集群与-docker" class="headerlink" title="启动 consul 集群与 docker"></a>启动 consul 集群与 docker</h2><p>通过 vagrant 起三台虚拟机实现基本的 consul 集群环境（为了节约资源把 docker 也运行在这上面了）。<br>consul 的 vagrant 配置文件如下：</p><figure class="hljs highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br></pre></td><td class="code"><pre><code class="hljs undefined"><span class="hljs-comment"># -*- mode: ruby -*-</span><br><span class="hljs-comment"># vi: set ft=ruby :</span><br><br><span class="hljs-comment"># All Vagrant configuration is done below. The "2" in Vagrant.configure</span><br><span class="hljs-comment"># configures the configuration version (we support older styles for</span><br><span class="hljs-comment"># backwards compatibility). Please don't change it unless you know what</span><br><span class="hljs-comment"># you're doing.</span><br>Vagrant.configure("2") <span class="hljs-keyword">do</span> |config|<br><br>$script = &lt;&lt;SCRIPT<br><br>echo <span class="hljs-string">"Installing"</span><br><br>yum <span class="hljs-keyword">install</span> -y wget<br>wget -O /etc/yum.repos.d/CentOS-Base.repo <span class="hljs-keyword">http</span>://mirrors.aliyun.com/repo/Centos<span class="hljs-number">-7.</span>repo<br>wget -O /etc/yum.repos.d/epel.repo <span class="hljs-keyword">http</span>://mirrors.aliyun.com/repo/epel<span class="hljs-number">-7.</span>repo<br>yum clean <span class="hljs-keyword">all</span><br>yum makecache<br><br>yum <span class="hljs-keyword">install</span> -y jq unzip vim wget net-tools bind-utils dnsmasq<br><br>sudo cp /vagrant/consul /usr/<span class="hljs-keyword">bin</span>/consul<br><br>echo <span class="hljs-string">"Installing docker.."</span> <br>sudo yum <span class="hljs-keyword">install</span> -y yum-utils device-mapper-persistent-<span class="hljs-keyword">data</span> lvm2<br>sudo yum-config-manager <span class="hljs-comment">--add-repo http://mirrors.aliyun.com/docker-ce/linux/centos/docker-ce.repo</span><br>sudo yum <span class="hljs-keyword">install</span> -y docker-ce docker-ce-cli containerd.io<br>sudo systemctl <span class="hljs-keyword">start</span> docker<br><br>echo <span class="hljs-string">"success"</span> <br><br>SCRIPT<br>  <span class="hljs-comment"># The most common configuration options are documented and commented below.</span><br>  <span class="hljs-comment"># For a complete reference, please see the online documentation at</span><br>  <span class="hljs-comment"># https://docs.vagrantup.com.</span><br><br>  <span class="hljs-comment"># Every Vagrant development environment requires a box. You can search for</span><br>  <span class="hljs-comment"># boxes at https://vagrantcloud.com/search.</span><br>  config.vm.box = <span class="hljs-string">"centos/7"</span><br>  config.vm.provision <span class="hljs-string">"shell"</span>, inline: $script<br><br>  config.vm.define <span class="hljs-string">"node1"</span> <span class="hljs-keyword">do</span> |node1|<br>    node1.vm.hostname = <span class="hljs-string">"node1"</span><br>    node1.vm.network <span class="hljs-string">"private_network"</span>, ip: <span class="hljs-string">"172.17.17.11"</span><br><br>  <span class="hljs-keyword">end</span><br><br>  config.vm.define <span class="hljs-string">"node2"</span> <span class="hljs-keyword">do</span> |node2|<br>    node2.vm.hostname = <span class="hljs-string">"node2"</span><br>    node2.vm.network <span class="hljs-string">"private_network"</span>, ip: <span class="hljs-string">"172.17.17.12"</span><br>  <span class="hljs-keyword">end</span><br><br>  config.vm.define <span class="hljs-string">"node3"</span> <span class="hljs-keyword">do</span> |node3|<br>    node3.vm.hostname = <span class="hljs-string">"node3"</span><br>    node3.vm.network <span class="hljs-string">"private_network"</span>, ip: <span class="hljs-string">"172.17.17.13"</span><br>  <span class="hljs-keyword">end</span><br>  <span class="hljs-comment"># Disable automatic box update checking. If you disable this, then</span><br>  <span class="hljs-comment"># boxes will only be checked for updates when the user runs</span><br>  <span class="hljs-comment"># `vagrant box outdated`. This is not recommended.</span><br>  config.vm.box_check_update = <span class="hljs-literal">false</span><br><br>  <span class="hljs-comment"># Create a forwarded port mapping which allows access to a specific port</span><br>  <span class="hljs-comment"># within the machine from a port on the host machine. In the example below,</span><br>  <span class="hljs-comment"># accessing "localhost:8080" will access port 80 on the guest machine.</span><br>  <span class="hljs-comment"># <span class="hljs-doctag">NOTE:</span> This will enable public access to the opened port</span><br>  <span class="hljs-comment"># config.vm.network "forwarded_port", guest: 80, host: 8080</span><br><br>  <span class="hljs-comment"># Create a forwarded port mapping which allows access to a specific port</span><br>  <span class="hljs-comment"># within the machine from a port on the host machine and only allow access</span><br>  <span class="hljs-comment"># via 127.0.0.1 to disable public access</span><br>  <span class="hljs-comment"># config.vm.network "forwarded_port", guest: 80, host: 8080, host_ip: "127.0.0.1"</span><br><br>  <span class="hljs-comment"># Create a private network, which allows host-only access to the machine</span><br>  <span class="hljs-comment"># using a specific IP.</span><br>  <span class="hljs-comment"># config.vm.network "private_network", ip: "192.168.33.10"</span><br><br>  <span class="hljs-comment"># Create a public network, which generally matched to bridged network.</span><br>  <span class="hljs-comment"># Bridged networks make the machine appear as another physical device on</span><br>  <span class="hljs-comment"># your network.</span><br>  <span class="hljs-comment"># config.vm.network "public_network"</span><br><br>  <span class="hljs-comment"># Share an additional folder to the guest VM. The first argument is</span><br>  <span class="hljs-comment"># the path on the host to the actual folder. The second argument is</span><br>  <span class="hljs-comment"># the path on the guest to mount the folder. And the optional third</span><br>  <span class="hljs-comment"># argument is a set of non-required options.</span><br>  <span class="hljs-comment"># config.vm.synced_folder "../data", "/vagrant_data"</span><br><br>  <span class="hljs-comment"># Provider-specific configuration so you can fine-tune various</span><br>  <span class="hljs-comment"># backing providers for Vagrant. These expose provider-specific options.</span><br>  <span class="hljs-comment"># Example for VirtualBox:</span><br>  <span class="hljs-comment">#</span><br>   config.vm.provider <span class="hljs-string">"virtualbox"</span> <span class="hljs-keyword">do</span> |vb|<br>  <span class="hljs-comment">#   # Display the VirtualBox GUI when booting the machine</span><br>  <span class="hljs-comment">#   vb.gui = true</span><br>  <span class="hljs-comment">#</span><br>  <span class="hljs-comment">#   # Customize the amount of memory on the VM:</span><br>     vb.memory = <span class="hljs-string">"1024"</span><br>   <span class="hljs-keyword">end</span><br>  <span class="hljs-comment">#</span><br>  <span class="hljs-comment"># View the documentation for the provider you are using for more</span><br>  <span class="hljs-comment"># information on available options.</span><br><br>  <span class="hljs-comment"># Enable provisioning with a shell script. Additional provisioners such as</span><br>  <span class="hljs-comment"># Puppet, Chef, Ansible, Salt, and Docker are also available. Please see the</span><br>  <span class="hljs-comment"># documentation for more information about their specific syntax and use.</span><br>  <span class="hljs-comment"># config.vm.provision "shell", inline: &lt;&lt;-SHELL</span><br>  <span class="hljs-comment">#   apt-get update</span><br>  <span class="hljs-comment">#   apt-get install -y apache2</span><br>  <span class="hljs-comment"># SHELL</span><br><span class="hljs-keyword">end</span><br></code></pre></td></tr></table></figure><p>为了节省时间我直接下载好了 consul 的可执行文件放到了 vagrant 配置文件同目录下，vagrant 会把当前目录下的文件都复制进虚拟机的 <code>/vagrant</code> 目录下，还有三个节点的 consul 配置文件。</p><p>node1</p><figure class="hljs highlight json"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><code class="hljs json">&#123;<br>    <span class="hljs-attr">"datacenter"</span>:<span class="hljs-string">"dc1"</span>,<br>    <span class="hljs-attr">"primary_datacenter"</span>:<span class="hljs-string">"dc1"</span>,<br>    <span class="hljs-attr">"bootstrap_expect"</span>:<span class="hljs-number">3</span>,<br>    <span class="hljs-attr">"advertise_addr"</span>: <span class="hljs-string">"172.17.17.11"</span>,<br>    <span class="hljs-attr">"bind_addr"</span>: <span class="hljs-string">"172.17.17.11"</span>,<br>    <span class="hljs-attr">"client_addr"</span>:<span class="hljs-string">"0.0.0.0"</span>,<br>    <span class="hljs-attr">"server"</span>:<span class="hljs-literal">true</span>,<br>    <span class="hljs-attr">"node_name"</span>:<span class="hljs-string">"node1"</span>,<br>    <span class="hljs-attr">"ui"</span>:<span class="hljs-literal">true</span>,<br>    <span class="hljs-attr">"data_dir"</span>:<span class="hljs-string">"/opt/consul"</span>,<br>    <span class="hljs-attr">"enable_script_checks"</span>:<span class="hljs-literal">true</span>,<br>    <span class="hljs-attr">"enable_local_script_checks"</span>:<span class="hljs-literal">true</span>,<br>    <span class="hljs-attr">"log_file"</span>:<span class="hljs-string">"/opt/consul/"</span>,<br>    <span class="hljs-attr">"log_level"</span>:<span class="hljs-string">"info"</span>,<br>    <span class="hljs-attr">"log_rotate_duration"</span>:<span class="hljs-string">"24h"</span><br>&#125;<br></code></pre></td></tr></table></figure><p>node2</p><figure class="hljs highlight json"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><code class="hljs json">&#123;<br>    <span class="hljs-attr">"datacenter"</span>:<span class="hljs-string">"dc1"</span>,<br>    <span class="hljs-attr">"primary_datacenter"</span>:<span class="hljs-string">"dc1"</span>,<br>    <span class="hljs-attr">"advertise_addr"</span>: <span class="hljs-string">"172.17.17.12"</span>,<br>    <span class="hljs-attr">"bind_addr"</span>: <span class="hljs-string">"172.17.17.12"</span>,<br>    <span class="hljs-attr">"client_addr"</span>:<span class="hljs-string">"0.0.0.0"</span>,<br>    <span class="hljs-attr">"server"</span>:<span class="hljs-literal">true</span>,<br>    <span class="hljs-attr">"node_name"</span>:<span class="hljs-string">"node2"</span>,<br>    <span class="hljs-attr">"ui"</span>:<span class="hljs-literal">true</span>,<br>    <span class="hljs-attr">"data_dir"</span>:<span class="hljs-string">"/opt/consul"</span>,<br>    <span class="hljs-attr">"enable_script_checks"</span>:<span class="hljs-literal">true</span>,<br>    <span class="hljs-attr">"enable_local_script_checks"</span>:<span class="hljs-literal">true</span>,<br>    <span class="hljs-attr">"log_file"</span>:<span class="hljs-string">"/opt/consul/"</span>,<br>    <span class="hljs-attr">"log_level"</span>:<span class="hljs-string">"info"</span>,<br>    <span class="hljs-attr">"log_rotate_duration"</span>:<span class="hljs-string">"24h"</span>,<br>    <span class="hljs-attr">"start_join"</span>:[<br>        <span class="hljs-string">"172.17.17.11"</span><br>    ],<br>    <span class="hljs-attr">"retry_join"</span>:[<br>        <span class="hljs-string">"172.17.17.11"</span><br>    ]<br>&#125;<br></code></pre></td></tr></table></figure><p>node3</p><figure class="hljs highlight json"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><code class="hljs json">&#123;<br>    <span class="hljs-attr">"datacenter"</span>:<span class="hljs-string">"dc1"</span>,<br>    <span class="hljs-attr">"primary_datacenter"</span>:<span class="hljs-string">"dc1"</span>,<br>    <span class="hljs-attr">"advertise_addr"</span>: <span class="hljs-string">"172.17.17.13"</span>,<br>    <span class="hljs-attr">"bind_addr"</span>: <span class="hljs-string">"172.17.17.13"</span>,<br>    <span class="hljs-attr">"client_addr"</span>:<span class="hljs-string">"0.0.0.0"</span>,<br>    <span class="hljs-attr">"server"</span>:<span class="hljs-literal">true</span>,<br>    <span class="hljs-attr">"node_name"</span>:<span class="hljs-string">"node3"</span>,<br>    <span class="hljs-attr">"ui"</span>:<span class="hljs-literal">true</span>,<br>    <span class="hljs-attr">"data_dir"</span>:<span class="hljs-string">"/opt/consul"</span>,<br>    <span class="hljs-attr">"enable_script_checks"</span>:<span class="hljs-literal">true</span>,<br>    <span class="hljs-attr">"enable_local_script_checks"</span>:<span class="hljs-literal">true</span>,<br>    <span class="hljs-attr">"log_file"</span>:<span class="hljs-string">"/opt/consul/"</span>,<br>    <span class="hljs-attr">"log_level"</span>:<span class="hljs-string">"info"</span>,<br>    <span class="hljs-attr">"log_rotate_duration"</span>:<span class="hljs-string">"24h"</span>,<br>    <span class="hljs-attr">"start_join"</span>:[<br>        <span class="hljs-string">"172.17.17.11"</span><br>    ],<br>    <span class="hljs-attr">"retry_join"</span>:[<br>        <span class="hljs-string">"172.17.17.11"</span><br>    ]<br><br>&#125;<br></code></pre></td></tr></table></figure><p>三个节点分别是</p><ul><li>node1 172.17.17.11</li><li>node2 172.17.17.12</li><li>node3 172.17.17.13</li></ul><p>运行 <code>vagrant up --provider=virtualbox</code> 把三个节点启动。</p><p>分别进入三个节点先 <code>sudo su -</code> 切换成 root 用户，然后把 consul 起来，再 exit 退出就会后台运行了。</p><figure class="hljs highlight autoit"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><code class="hljs undefined">[root<span class="hljs-symbol">@node1</span> ~]<span class="hljs-meta"># consul agent -config-file /vagrant/node1.json &amp;</span><br>[root<span class="hljs-symbol">@node2</span> ~]<span class="hljs-meta"># consul agent -config-file /vagrant/node2.json &amp;</span><br>[root<span class="hljs-symbol">@node3</span> ~]<span class="hljs-meta"># consul agent -config-file /vagrant/node3.json &amp;</span><br></code></pre></td></tr></table></figure><p>在三个节点上分别通过 docker 运行 web 服务，对外端口是 32768</p><figure class="hljs highlight autoit"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs undefined">[root<span class="hljs-symbol">@node1</span> ~]<span class="hljs-meta"># docker run -d -p 32768:80 --name test containous/whoami</span><br></code></pre></td></tr></table></figure><h2 id="服务注册"><a href="#服务注册" class="headerlink" title="服务注册"></a>服务注册</h2><p>在三个节点上分别把刚才的 web 服务注册到 consul，这一步在实际项目中可以写到 docker image build 中，然后在容器启动的时候就注册到 consul。</p><figure class="hljs highlight kotlin"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs undefined">[<span class="hljs-symbol">root@</span>node1 ~]# curl --request PUT --<span class="hljs-keyword">data</span> <span class="hljs-meta">@web</span>.json http:<span class="hljs-comment">//127.0.0.1:8500/v1/agent/service/register?replace-existing-checks=true</span><br></code></pre></td></tr></table></figure><p>web.json 内容如下</p><figure class="hljs highlight json"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><code class="hljs json">&#123;<br>  <span class="hljs-attr">"ID"</span>: <span class="hljs-string">"web"</span>,<br>  <span class="hljs-attr">"Name"</span>: <span class="hljs-string">"consul_web"</span>,<br>  <span class="hljs-attr">"Tags"</span>: [<br>    <span class="hljs-string">"whoami"</span><br>  ],<br>  <span class="hljs-attr">"Check"</span>: &#123;<br>    <span class="hljs-attr">"Args"</span>: [<span class="hljs-string">"curl"</span>, <span class="hljs-string">"172.17.17.11:32768"</span>],<br>    <span class="hljs-attr">"Interval"</span>: <span class="hljs-string">"10s"</span>,<br>    <span class="hljs-attr">"Timeout"</span>: <span class="hljs-string">"3s"</span><br>  &#125;,<br>  <span class="hljs-attr">"Address"</span>: <span class="hljs-string">"172.17.17.11"</span>,<br>  <span class="hljs-attr">"Port"</span>: <span class="hljs-number">32768</span><br>&#125;<br></code></pre></td></tr></table></figure><p>其中增加了简单的健康检查, ip 部分每个节点修改成自己的。</p><p>现在通过访问 <code>http://172.17.17.11:8500/</code> 可以看到如下的信息</p><p><img src="/images/15809958438706.jpg" alt></p><p>随便找一个节点通过 consul 自带的 dns 查询下服务，可以看到返回了所有健康的服务节点。</p><figure class="hljs highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br></pre></td><td class="code"><pre><code class="hljs undefined"><span class="hljs-string">[root@node1</span> <span class="hljs-string">~]#</span> <span class="hljs-string">dig</span> <span class="hljs-string">@127.0.0.1</span> <span class="hljs-bullet">-p</span> <span class="hljs-number">8600</span> <span class="hljs-string">consul_web.service.consul</span><br><br><span class="hljs-string">;</span> <span class="hljs-string">&lt;&lt;&gt;&gt;</span> <span class="hljs-string">DiG</span> <span class="hljs-number">9.11</span><span class="hljs-number">.4</span><span class="hljs-bullet">-P2-RedHat-9.11.4-9.P2.el7</span> <span class="hljs-string">&lt;&lt;&gt;&gt;</span> <span class="hljs-string">@127.0.0.1</span> <span class="hljs-bullet">-p</span> <span class="hljs-number">8600</span> <span class="hljs-string">consul_web.service.consul</span><br><span class="hljs-string">;</span> <span class="hljs-string">(1</span> <span class="hljs-string">server</span> <span class="hljs-string">found)</span><br><span class="hljs-string">;;</span> <span class="hljs-string">global</span> <span class="hljs-attr">options:</span> <span class="hljs-string">+cmd</span><br><span class="hljs-string">;;</span> <span class="hljs-string">Got</span> <span class="hljs-attr">answer:</span><br><span class="hljs-string">;;</span> <span class="hljs-bullet">-&gt;&gt;HEADER&lt;&lt;-</span> <span class="hljs-attr">opcode:</span> <span class="hljs-string">QUERY,</span> <span class="hljs-attr">status:</span> <span class="hljs-string">NOERROR,</span> <span class="hljs-attr">id:</span> <span class="hljs-number">11034</span><br><span class="hljs-string">;;</span> <span class="hljs-attr">flags:</span> <span class="hljs-string">qr</span> <span class="hljs-string">aa</span> <span class="hljs-string">rd;</span> <span class="hljs-attr">QUERY:</span> <span class="hljs-number">1</span><span class="hljs-string">,</span> <span class="hljs-attr">ANSWER:</span> <span class="hljs-number">3</span><span class="hljs-string">,</span> <span class="hljs-attr">AUTHORITY:</span> <span class="hljs-number">0</span><span class="hljs-string">,</span> <span class="hljs-attr">ADDITIONAL:</span> <span class="hljs-number">4</span><br><span class="hljs-string">;;</span> <span class="hljs-attr">WARNING:</span> <span class="hljs-string">recursion</span> <span class="hljs-string">requested</span> <span class="hljs-string">but</span> <span class="hljs-string">not</span> <span class="hljs-string">available</span><br><br><span class="hljs-string">;;</span> <span class="hljs-string">OPT</span> <span class="hljs-attr">PSEUDOSECTION:</span><br><span class="hljs-string">;</span> <span class="hljs-attr">EDNS:</span> <span class="hljs-attr">version:</span> <span class="hljs-number">0</span><span class="hljs-string">,</span> <span class="hljs-attr">flags:;</span> <span class="hljs-attr">udp:</span> <span class="hljs-number">4096</span><br><span class="hljs-string">;;</span> <span class="hljs-string">QUESTION</span> <span class="hljs-attr">SECTION:</span><br><span class="hljs-string">;consul_web.service.consul.</span>	<span class="hljs-string">IN</span>	<span class="hljs-string">A</span><br><br><span class="hljs-string">;;</span> <span class="hljs-string">ANSWER</span> <span class="hljs-attr">SECTION:</span><br><span class="hljs-string">consul_web.service.consul.</span> <span class="hljs-number">0</span>	<span class="hljs-string">IN</span>	<span class="hljs-string">A</span>	<span class="hljs-number">172.17</span><span class="hljs-number">.17</span><span class="hljs-number">.11</span><br><span class="hljs-string">consul_web.service.consul.</span> <span class="hljs-number">0</span>	<span class="hljs-string">IN</span>	<span class="hljs-string">A</span>	<span class="hljs-number">172.17</span><span class="hljs-number">.17</span><span class="hljs-number">.13</span><br><span class="hljs-string">consul_web.service.consul.</span> <span class="hljs-number">0</span>	<span class="hljs-string">IN</span>	<span class="hljs-string">A</span>	<span class="hljs-number">172.17</span><span class="hljs-number">.17</span><span class="hljs-number">.12</span><br><br><span class="hljs-string">;;</span> <span class="hljs-string">ADDITIONAL</span> <span class="hljs-attr">SECTION:</span><br><span class="hljs-string">consul_web.service.consul.</span> <span class="hljs-number">0</span>	<span class="hljs-string">IN</span>	<span class="hljs-string">TXT</span>	<span class="hljs-string">"consul-network-segment="</span><br><span class="hljs-string">consul_web.service.consul.</span> <span class="hljs-number">0</span>	<span class="hljs-string">IN</span>	<span class="hljs-string">TXT</span>	<span class="hljs-string">"consul-network-segment="</span><br><span class="hljs-string">consul_web.service.consul.</span> <span class="hljs-number">0</span>	<span class="hljs-string">IN</span>	<span class="hljs-string">TXT</span>	<span class="hljs-string">"consul-network-segment="</span><br><br><span class="hljs-string">;;</span> <span class="hljs-string">Query</span> <span class="hljs-attr">time:</span> <span class="hljs-number">0</span> <span class="hljs-string">msec</span><br><span class="hljs-string">;;</span> <span class="hljs-attr">SERVER:</span> <span class="hljs-number">127.0</span><span class="hljs-number">.0</span><span class="hljs-number">.1</span><span class="hljs-comment">#8600(127.0.0.1)</span><br><span class="hljs-string">;;</span> <span class="hljs-attr">WHEN:</span> <span class="hljs-string">Thu</span> <span class="hljs-string">Feb</span> <span class="hljs-number">06</span> <span class="hljs-number">13</span><span class="hljs-string">:10:12</span> <span class="hljs-string">UTC</span> <span class="hljs-number">2020</span><br><span class="hljs-string">;;</span> <span class="hljs-string">MSG</span> <span class="hljs-string">SIZE</span>  <span class="hljs-attr">rcvd:</span> <span class="hljs-number">210</span><br></code></pre></td></tr></table></figure><h2 id="服务发现-dns"><a href="#服务发现-dns" class="headerlink" title="服务发现 dns"></a>服务发现 dns</h2><p>通过 dnsmasq 将节点的 dns 修改为 consul 的，先创建配置文件 <code>/etc/dnsmasq.d/10-consul</code> 内容为</p><figure class="hljs highlight lsl"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><code class="hljs undefined">server=/consul/<span class="hljs-number">127.0</span><span class="hljs-number">.0</span><span class="hljs-number">.1</span>#<span class="hljs-number">8600</span><br>server=<span class="hljs-number">223.5</span><span class="hljs-number">.5</span><span class="hljs-number">.5</span><br></code></pre></td></tr></table></figure><p>然后运行 <code>systemctl start dnsmasq</code> 启动 dnsmasq，再把 <code>/etc/resolv.conf</code> dns 服务器地址改成 <code>127.0.0.1</code>。</p><p>通过 curl 访问</p><figure class="hljs highlight ldif"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><code class="hljs undefined">[root@node1 ~]<span class="hljs-comment"># curl http://consul_web.service.consul:32768 -i</span><br><span class="hljs-attribute">HTTP/1.1 200 OK<br>Date</span>: Thu, 06 Feb 2020 13:19:43 GMT<br><span class="hljs-attribute">Content-Length</span>: 178<br><span class="hljs-attribute">Content-Type</span>: text/plain; charset=utf-8<br><br><span class="hljs-attribute">Hostname</span>: 2cc06cae3b6e<br><span class="hljs-attribute">IP</span>: 127.0.0.1<br><span class="hljs-attribute">IP</span>: 172.18.0.2<br><span class="hljs-attribute">RemoteAddr</span>: 172.17.17.11:54108<br><span class="hljs-attribute">GET / HTTP/1.1<br>Host</span>: consul_web.service.consul:32768<br><span class="hljs-attribute">User-Agent</span>: curl/7.29.0<br><span class="hljs-attribute">Accept</span>: */*<br></code></pre></td></tr></table></figure><p>把 docker 中 dns 配置修改为当前节点的，配置文件 <code>/etc/docker/daemon.json</code></p><figure class="hljs highlight json"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><code class="hljs json">&#123;<br>    <span class="hljs-attr">"dns"</span>: [<span class="hljs-string">"172.17.17.11"</span>],<br>    <span class="hljs-attr">"dns-search"</span>: [<span class="hljs-string">"service.consul"</span>],<br>&#125;<br></code></pre></td></tr></table></figure><p>这样在 docker 容器内部就可以通过 consul 的 dns 来进行服务发现了。现在服务的注册与内部的服务发现都已经完成了。</p><h2 id="traefik"><a href="#traefik" class="headerlink" title="traefik"></a>traefik</h2><p>对于外部流量的进入与路由使用 Traefik 来管理。</p><p>起一台跑 traefik 的 vagrant 配置文件如下，同样下载了 traefik 的可执行文件到当前目录。</p><figure class="hljs highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br></pre></td><td class="code"><pre><code class="hljs undefined"><span class="hljs-comment"># -*- mode: ruby -*-</span><br><span class="hljs-comment"># vi: set ft=ruby :</span><br><br><span class="hljs-comment"># All Vagrant configuration is done below. The "2" in Vagrant.configure</span><br><span class="hljs-comment"># configures the configuration version (we support older styles for</span><br><span class="hljs-comment"># backwards compatibility). Please don't change it unless you know what</span><br><span class="hljs-comment"># you're doing.</span><br>Vagrant.configure("2") <span class="hljs-keyword">do</span> |config|<br><br>$script = &lt;&lt;SCRIPT<br><br>yum <span class="hljs-keyword">install</span> -y wget<br>wget -O /etc/yum.repos.d/CentOS-Base.repo <span class="hljs-keyword">http</span>://mirrors.aliyun.com/repo/Centos<span class="hljs-number">-7.</span>repo<br>wget -O /etc/yum.repos.d/epel.repo <span class="hljs-keyword">http</span>://mirrors.aliyun.com/repo/epel<span class="hljs-number">-7.</span>repo<br>yum clean <span class="hljs-keyword">all</span><br>yum makecache<br><br>yum <span class="hljs-keyword">install</span> -y jq unzip vim wget net-tools bind-utils dnsmasq<br><br>sudo cp /vagrant/consul /usr/<span class="hljs-keyword">bin</span>/consul<br>sudo cp /vagrant/traefik /usr/<span class="hljs-keyword">bin</span>/traefik<br><br>echo <span class="hljs-string">"success"</span><br><br>SCRIPT<br>  <span class="hljs-comment"># The most common configuration options are documented and commented below.</span><br>  <span class="hljs-comment"># For a complete reference, please see the online documentation at</span><br>  <span class="hljs-comment"># https://docs.vagrantup.com.</span><br><br>  <span class="hljs-comment"># Every Vagrant development environment requires a box. You can search for</span><br>  <span class="hljs-comment"># boxes at https://vagrantcloud.com/search.</span><br>  config.vm.box = <span class="hljs-string">"centos/7"</span><br>  config.vm.provision <span class="hljs-string">"shell"</span>, inline: $script<br><br>  config.vm.define <span class="hljs-string">"traefik"</span> <span class="hljs-keyword">do</span> |traefik|<br>      traefik.vm.hostname = <span class="hljs-string">"traefik"</span><br>      traefik.vm.network <span class="hljs-string">"private_network"</span>, ip: <span class="hljs-string">"172.17.17.21"</span><br>  <span class="hljs-keyword">end</span><br><br>  <span class="hljs-comment"># Disable automatic box update checking. If you disable this, then</span><br>  <span class="hljs-comment"># boxes will only be checked for updates when the user runs</span><br>  <span class="hljs-comment"># `vagrant box outdated`. This is not recommended.</span><br>  config.vm.box_check_update = <span class="hljs-literal">false</span><br><br>  <span class="hljs-comment"># Create a forwarded port mapping which allows access to a specific port</span><br>  <span class="hljs-comment"># within the machine from a port on the host machine. In the example below,</span><br>  <span class="hljs-comment"># accessing "localhost:8080" will access port 80 on the guest machine.</span><br>  <span class="hljs-comment"># <span class="hljs-doctag">NOTE:</span> This will enable public access to the opened port</span><br>  <span class="hljs-comment"># config.vm.network "forwarded_port", guest: 80, host: 8080</span><br><br>  <span class="hljs-comment"># Create a forwarded port mapping which allows access to a specific port</span><br>  <span class="hljs-comment"># within the machine from a port on the host machine and only allow access</span><br>  <span class="hljs-comment"># via 127.0.0.1 to disable public access</span><br>  <span class="hljs-comment"># config.vm.network "forwarded_port", guest: 80, host: 8080, host_ip: "127.0.0.1"</span><br><br>  <span class="hljs-comment"># Create a private network, which allows host-only access to the machine</span><br>  <span class="hljs-comment"># using a specific IP.</span><br>  <span class="hljs-comment"># config.vm.network "private_network", ip: "192.168.33.10"</span><br><br>  <span class="hljs-comment"># Create a public network, which generally matched to bridged network.</span><br>  <span class="hljs-comment"># Bridged networks make the machine appear as another physical device on</span><br>  <span class="hljs-comment"># your network.</span><br>  <span class="hljs-comment"># config.vm.network "public_network"</span><br><br>  <span class="hljs-comment"># Share an additional folder to the guest VM. The first argument is</span><br>  <span class="hljs-comment"># the path on the host to the actual folder. The second argument is</span><br>  <span class="hljs-comment"># the path on the guest to mount the folder. And the optional third</span><br>  <span class="hljs-comment"># argument is a set of non-required options.</span><br>  <span class="hljs-comment"># config.vm.synced_folder "../data", "/vagrant_data"</span><br><br>  <span class="hljs-comment"># Provider-specific configuration so you can fine-tune various</span><br>  <span class="hljs-comment"># backing providers for Vagrant. These expose provider-specific options.</span><br>  <span class="hljs-comment"># Example for VirtualBox:</span><br>  <span class="hljs-comment">#</span><br>   config.vm.provider <span class="hljs-string">"virtualbox"</span> <span class="hljs-keyword">do</span> |vb|<br>  <span class="hljs-comment">#   # Display the VirtualBox GUI when booting the machine</span><br>  <span class="hljs-comment">#   vb.gui = true</span><br>  <span class="hljs-comment">#</span><br>  <span class="hljs-comment">#   # Customize the amount of memory on the VM:</span><br>     vb.memory = <span class="hljs-string">"1024"</span><br>   <span class="hljs-keyword">end</span><br>  <span class="hljs-comment">#</span><br>  <span class="hljs-comment"># View the documentation for the provider you are using for more</span><br>  <span class="hljs-comment"># information on available options.</span><br><br>  <span class="hljs-comment"># Enable provisioning with a shell script. Additional provisioners such as</span><br>  <span class="hljs-comment"># Puppet, Chef, Ansible, Salt, and Docker are also available. Please see the</span><br>  <span class="hljs-comment"># documentation for more information about their specific syntax and use.</span><br>  <span class="hljs-comment"># config.vm.provision "shell", inline: &lt;&lt;-SHELL</span><br>  <span class="hljs-comment">#   apt-get update</span><br>  <span class="hljs-comment">#   apt-get install -y apache2</span><br>  <span class="hljs-comment"># SHELL</span><br><span class="hljs-keyword">end</span><br></code></pre></td></tr></table></figure><p>节点为</p><ul><li>traefik 172.17.17.21</li></ul><p>在 traefik 上运行一个 client 模式的 consul 的 agent，加入 consul 的集群</p><figure class="hljs highlight lsl"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs undefined">[root@traefik ~]# consul agent -data-dir /opt/consul -node=agent_traefik -bind=<span class="hljs-number">172.17</span><span class="hljs-number">.17</span><span class="hljs-number">.21</span> -join <span class="hljs-number">172.17</span><span class="hljs-number">.17</span><span class="hljs-number">.11</span> &amp;<br></code></pre></td></tr></table></figure><p>然后运行 traefik</p><figure class="hljs highlight autoit"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs undefined">[root<span class="hljs-symbol">@traefik</span> ~]<span class="hljs-meta"># traefik --configFile=/vagrant/config/traefik.toml</span><br></code></pre></td></tr></table></figure><p>配置文件 <code>/vagrant/config/traefik.toml</code> 内容</p><figure class="hljs highlight"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br></pre></td><td class="code"><pre><code class="hljs toml">[global]<br>  checkNewVersion = true<br>  sendAnonymousUsage = false<br><br>[api]<br>  insecure = true<br>  debug = true<br>  dashboard = true<br><br>[log]<br>  filePath = "/vagrant/logs/traefik.log"<br>  level = "DEBUG"<br>#  format = "json"<br>[accessLog]<br>  filePath = "/vagrant/logs/access.log"<br><br>[entryPoints]<br>  [entryPoints.web]<br>    address = ":80"<br>  [entryPoints.web-secure]<br>    address = ":443"<br><br>#[certificatesResolvers.sample.acme]<br>#  email = ""<br>#  storage = "acme.json"<br>#  [certificatesResolvers.sample.acme.httpChallenge]<br>#    entryPoint = "web"<br>#  caServer = "https://acme-staging-v02.api.letsencrypt.org/directory"<br>#  [certificatesResolvers.sample.acme.tlsChallenge]<br><br>[providers]<br>  [providers.consulCatalog]<br>    exposedByDefault = false<br>    refreshInterval = "5s"<br>  [providers.file]<br>    filename = "/vagrant/config/static.toml"<br>    watch = true<br></code></pre></td></tr></table></figure><p>配置文件 <code>/vagrant/config/static.toml</code></p><figure class="hljs highlight"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br></pre></td><td class="code"><pre><code class="hljs toml"># 强制所有 http 请求转 https<br>#[http.routers.http-catchall]<br>#  rule = "hostregexp(`&#123;host:.+&#125;`)"<br>#  entrypoints = ["web"]<br>#  service = "api@internal"<br>#  middlewares = ["toHttps"]<br><br># https 路由<br>#[http.routers.my-api]<br>#  rule = "Host(`traefik.haozy.com`)"<br>#  service = "api@internal"<br>#  middlewares = ["auth"]<br>#  [http.routers.my-api.tls]<br>#    certResolver = "sample"<br>#    [[http.routers.my-api.tls.domains]]<br>#      main = "traefik.haozy.com"<br><br>#[http.middlewares.toHttps.redirectScheme]<br>#    scheme = "https"<br><br># http 路由<br>[http.routers.my-api-http]<br>  rule = "Host(`traefik.haozy.com`)"<br>  entrypoints = ["web"]<br>  service = "api@internal"<br>  middlewares = ["auth"]<br><br>[http.middlewares.auth.basicAuth]<br>  # 密码生成 echo $(htpasswd -nb haozy 123456)<br>  users = [<br>    "haozy:$$apr1$$pfkpgu.w$$jHQtt8T96PdvyojTBgh5E/",<br>  ]<br></code></pre></td></tr></table></figure><p>将域名 <code>traefik.haozy.com</code> host 指到 <code>172.17.17.21</code> ，访问 <code>traefik.haozy.com</code> 因为配了 auth 验证，输入用户名密码后就可以看到管理界面了。https 也很简单，因为本地测试先注释了对应的配置。</p><p>现在将 node1、node2、node3 节点上注册的 web 服务删除，在 web.json 中增加 traefik 相关的 tag，再重新注册。</p><p>web.json</p><figure class="hljs highlight json"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><code class="hljs json">&#123;<br>  <span class="hljs-attr">"ID"</span>: <span class="hljs-string">"web"</span>,<br>  <span class="hljs-attr">"Name"</span>: <span class="hljs-string">"consul_web"</span>,<br>  <span class="hljs-attr">"Tags"</span>: [<br>    <span class="hljs-string">"whoami"</span>,<br>    <span class="hljs-string">"traefik.enable=true"</span>,<br>    <span class="hljs-string">"traefik.http.routers.consul_web.rule=Host(`web.haozy.com`)"</span>,<br>    <span class="hljs-string">"traefik.http.routers.consul_web.entrypoints=web"</span>,<br>    <span class="hljs-string">"traefik.http.services.consul_web.loadbalancer.passhostheader=true"</span><br>  ],<br>  <span class="hljs-attr">"Check"</span>: &#123;<br>    <span class="hljs-attr">"Args"</span>: [<span class="hljs-string">"curl"</span>, <span class="hljs-string">"172.17.17.11:32768"</span>],<br>    <span class="hljs-attr">"Interval"</span>: <span class="hljs-string">"10s"</span>,<br>    <span class="hljs-attr">"Timeout"</span>: <span class="hljs-string">"3s"</span><br>  &#125;,<br>  <span class="hljs-attr">"Address"</span>: <span class="hljs-string">"172.17.17.11"</span>,<br>  <span class="hljs-attr">"Port"</span>: <span class="hljs-number">32768</span><br>&#125;<br></code></pre></td></tr></table></figure><figure class="hljs highlight kotlin"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><code class="hljs undefined">[<span class="hljs-symbol">root@</span>node1 ~]# curl --request PUT http:<span class="hljs-comment">//127.0.0.1:8500/v1/agent/service/deregister/web</span><br>[<span class="hljs-symbol">root@</span>node1 ~]# curl --request PUT --<span class="hljs-keyword">data</span> <span class="hljs-meta">@web</span>.json http:<span class="hljs-comment">//127.0.0.1:8500/v1/agent/service/register?replace-existing-checks=true</span><br></code></pre></td></tr></table></figure><p>现在通过 traefik 管理界面可以看到 <code>web.consul.com</code> 的路由信息，以及对应的后端服务。</p><p><img src="/images/15809977638894.jpg" alt><br><img src="/images/15809978310478.jpg" alt><br><img src="/images/15809978767331.jpg" alt></p><p>将域名 <code>web.haozy.com</code> 指向 <code>172.17.17.21</code>，请求会轮训请求所有后端服务。至此外部流量的负载均衡与路由就完成了，当然 traefik 中的 Routers 和 Middlewares 还可以实现很多复杂的处理。</p><p>再多说一点，traefik 2.0 开始分成静态配置文件和动态配置，在静态文件中配置的 Routers、Middlewares 之类的是可以在动态配置中调用的，省去了很多定义，比如调用静态配置文件中的 auth。<br><code>traefik.http.routers.consul_web.middlewares=auth@file</code></p></main><footer class="post-footer"><div class="post-tags"><a class="post-tag button" href="/tags/Docker/" rel="tag"><i class="fas fa-tags"></i>Docker</a> <a class="post-tag button" href="/tags/%E5%BE%AE%E6%9C%8D%E5%8A%A1/" rel="tag"><i class="fas fa-tags"></i>微服务</a> <a class="post-tag button" href="/tags/Consul/" rel="tag"><i class="fas fa-tags"></i>Consul</a> <a class="post-tag button" href="/tags/Traefik/" rel="tag"><i class="fas fa-tags"></i>Traefik</a></div></footer></article><nav class="page-nav"><div class="page-nav-next page-nav-item"><a href="/2020/01/30/last_bug_for_2019/" rel="next" title="年前线上问题总结"><i class="fas fa-angle-left"></i><span class="nav-title">年前线上问题总结</span></a></div><div class="page-nav-prev page-nav-item"><a href="/2020/05/11/swoole_slowlog/" rel="prev" title="Swoole slowlog 乱码修复"><span class="nav-title">Swoole slowlog 乱码修复</span><i class="fas fa-angle-right"></i></a></div></nav><link rel="stylesheet" href="//api.ibelieving.io/src/iDisqus.min.css?v=20190831"><script src="//api.ibelieving.io/src/iDisqus.min.js?v=20190831"></script><div id="comment"></div><script>function loadDisqus(){new iDisqus("comment",{forum:"ibelieving",site:"https://ibelieving.io",api:"https://api.ibelieving.io/api",url:"2020/02/06/consul_and_traefik_micro_service/",mode:1,timeout:2e3,init:!0,emojiPreview:!0}).count()}var runningOnBrowser="undefined"!=typeof window,isBot=runningOnBrowser&&!("onscroll"in window)||"undefined"!=typeof navigator&&/(gle|ing|ro|msn)bot|crawl|spider|yand|duckgo/i.test(navigator.userAgent),supportsIntersectionObserver=runningOnBrowser&&"IntersectionObserver"in window;setTimeout(function(){var n;!isBot&&supportsIntersectionObserver?(n=new IntersectionObserver(function(e){e[0].isIntersecting&&(loadDisqus(),n.disconnect())},{threshold:[0]})).observe(document.getElementById("comment")):loadDisqus()},1)</script></div></div><aside class="sidebar" id="sidebar"><div class="search"><div class="form-group"><i class="fas fa-search"></i><input type="search" id="search-input" name="q" results="0" placeholder="搜索" class="form-control"></div></div><div class="search-result-box" id="search-result"></div><div class="info sidebar-item" id="info"><img class="author-avatar" src="/images/avatar.gif" alt="Zhongyang Hao"><h1 class="author-name">Zhongyang Hao</h1><h2 class="author-description">技术分享，包括不限于微服务、服务网格。主要开发语言PHP、Golang。</h2><div class="blog-sidebar-tags"><h4 class="blog-sidebar-h4"><i class="fa fa-tag"></i>&nbsp;标签云</h4><ul class="blog-sidebar-tags-ul blog-sidebar-padding"><li><a href="/tags/Go/" class="tag-could" data-toggle="tooltip" data-placement="top" title="Go">Go</a></li><li><a href="/tags/%E7%88%AC%E8%99%AB/" class="tag-could" data-toggle="tooltip" data-placement="top" title="爬虫">爬虫</a></li><li><a href="/tags/Kindle/" class="tag-could" data-toggle="tooltip" data-placement="top" title="Kindle">Kindle</a></li><li><a href="/tags/mobi/" class="tag-could" data-toggle="tooltip" data-placement="top" title="mobi">mobi</a></li><li><a href="/tags/IDE/" class="tag-could" data-toggle="tooltip" data-placement="top" title="IDE">IDE</a></li><li><a href="/tags/Docker/" class="tag-could" data-toggle="tooltip" data-placement="top" title="Docker">Docker</a></li><li><a href="/tags/%E5%BE%AE%E6%9C%8D%E5%8A%A1/" class="tag-could" data-toggle="tooltip" data-placement="top" title="微服务">微服务</a></li><li><a href="/tags/PHP/" class="tag-could" data-toggle="tooltip" data-placement="top" title="PHP">PHP</a></li><li><a href="/tags/Swoole/" class="tag-could" data-toggle="tooltip" data-placement="top" title="Swoole">Swoole</a></li><li><a href="/tags/RabbitMQ/" class="tag-could" data-toggle="tooltip" data-placement="top" title="RabbitMQ">RabbitMQ</a></li><li><a href="/tags/%E6%BA%90%E7%A0%81/" class="tag-could" data-toggle="tooltip" data-placement="top" title="源码">源码</a></li><li><a href="/tags/Consul/" class="tag-could" data-toggle="tooltip" data-placement="top" title="Consul">Consul</a></li><li><a href="/tags/Traefik/" class="tag-could" data-toggle="tooltip" data-placement="top" title="Traefik">Traefik</a></li><li><a href="/tags/TCP/" class="tag-could" data-toggle="tooltip" data-placement="top" title="TCP">TCP</a></li><li><a href="/tags/nps/" class="tag-could" data-toggle="tooltip" data-placement="top" title="nps">nps</a></li><li><a href="/tags/%E5%86%85%E7%BD%91%E7%A9%BF%E9%80%8F/" class="tag-could" data-toggle="tooltip" data-placement="top" title="内网穿透">内网穿透</a></li><li><a href="/tags/%E5%BE%AE%E4%BF%A1%E5%B0%8F%E7%A8%8B%E5%BA%8F/" class="tag-could" data-toggle="tooltip" data-placement="top" title="微信小程序">微信小程序</a></li><li><a href="/tags/%E5%89%AF%E4%B8%9A/" class="tag-could" data-toggle="tooltip" data-placement="top" title="副业">副业</a></li><li><a href="/tags/Golang/" class="tag-could" data-toggle="tooltip" data-placement="top" title="Golang">Golang</a></li><li><a href="/tags/Serverless/" class="tag-could" data-toggle="tooltip" data-placement="top" title="Serverless">Serverless</a></li></ul></div><script>var tag_cloud=$(".tag-could");tag_cloud.each(function(){var a=parseInt(6*Math.random());$(this).addClass("tag-could"+a)})</script></div><div class="sidebar-sticky"><hr><div class="post-toc sidebar-item" id="toc-div"><div><i class="fas fa-list-ol"></i>文章目录</div><div class="post-toc-content"><ol class="list-group toc"><li class="toc-item toc-level-2"><a class="list-group-item toc-link" href="#启动-consul-集群与-docker"><span class="toc-text">启动 consul 集群与 docker</span></a></li><li class="toc-item toc-level-2"><a class="list-group-item toc-link" href="#服务注册"><span class="toc-text">服务注册</span></a></li><li class="toc-item toc-level-2"><a class="list-group-item toc-link" href="#服务发现-dns"><span class="toc-text">服务发现 dns</span></a></li><li class="toc-item toc-level-2"><a class="list-group-item toc-link" href="#traefik"><span class="toc-text">traefik</span></a></li></ol></div></div></div></aside><canvas class="bg-cas" id="bg-cas"></canvas><script>var canvas = document.getElementById("bg-cas");
  var ctx = canvas.getContext("2d");
  const pixelRatio = window.devicePixelRatio || 1;
  resize();
  window.onresize = resize;
  function resize() {
    canWidth = document.getElementById("sidebar").offsetWidth;
    canHeight = document.getElementById("sidebar").offsetHeight;
    canvas.width = canWidth * pixelRatio;
    canvas.height = canHeight * pixelRatio;
    canvas.style.width = canWidth + 'px';
    canvas.style.height = canHeight + 'px';
    ctx.scale(pixelRatio, pixelRatio);
    canvas.style.top = document.getElementById("sidebar").offsetTop + "px";
  }
  var RAF = (function() {
    return window.requestAnimationFrame || window.webkitRequestAnimationFrame || window.mozRequestAnimationFrame || window.oRequestAnimationFrame || window.msRequestAnimationFrame || function(callback) {
          window.setTimeout(callback, 1000 / 60);
        };
  })();
  var warea = {x: null, y: null, max: 20000};
/*  window.onmousemove = function(e) {
    e = e || window.event;
    warea.x = e.clientX;
    warea.y = e.clientY;
  };
  window.onmouseout = function(e) {
    warea.x = null;
    warea.y = null;
  };
*/
  var dots = [];
  for (var i = 0; i < 200 * pixelRatio; i++) {
    var x = Math.random() * canvas.width;
    var y = Math.random() * canvas.height;
    var xa = Math.random() * 2 - 1;
    var ya = Math.random() * 2 - 1;
    dots.push({
      x: x,
      y: y,
      xa: xa,
      ya: ya,
      max: 6000
    })
  }
  setTimeout(function() {
    animate();
  }, 500);
  function animate() {
    ctx.clearRect(0, 0, canvas.width, canvas.height);
    var ndots = [warea].concat(dots);
    dots.forEach(function(dot) {
      dot.x += dot.xa;
      dot.y += dot.ya;
      dot.xa *= (dot.x > canvas.width || dot.x < 0) ? -1 : 1;
      dot.ya *= (dot.y > canvas.height || dot.y < 0) ? -1 : 1;
      ctx.fillRect(dot.x - 0.5, dot.y - 0.5, 1, 1);
      for (var i = 0; i < ndots.length; i++) {
        var d2 = ndots[i];
        if (dot === d2 || d2.x === null || d2.y === null) continue;
        var xc = dot.x - d2.x;
        var yc = dot.y - d2.y;
        var dis = xc * xc + yc * yc;
        var ratio;
        if (dis < d2.max) {
//          if (d2 === warea && dis > (d2.max / 2)) {
//            dot.x -= xc * 0.03;
//            dot.y -= yc * 0.03;
//          }
          ratio = (d2.max - dis) / d2.max;
          ctx.beginPath();
          ctx.lineWidth = ratio / 2;
          ctx.strokeStyle = 'rgba(0,0,0,' + (ratio + 0.2) + ')';
          ctx.moveTo(dot.x, dot.y);
          ctx.lineTo(d2.x, d2.y);
          ctx.stroke();
        }
      }
     ndots.splice(ndots.indexOf(dot), 1);

    });
    RAF(animate);
  }</script></div></div></main><footer id="footer" class="footer" style="background:#000"><div class="container"><div class="back-to-top"><button id="back-to-top"><i class="fas fa-angle-double-up" aria-label="回到顶部"></i></button></div><div class="footer-container"><div class="footer-left"><div class="copyright"><span class="author">Zhongyang Hao</span><span class="year"><i class="far fa-copyright"></i>2017 - 2021</span><span class="creative-commons"><i class="fab fa-creative-commons"></i><a href="https://creativecommons.org/licenses/by-nc-sa/4.0/" target="_blank">BY-NC-SA 4.0</a></span></div><div class="busuanzi"><span id="busuanzi_container_site_pv"><i class="fas fa-eye" aria-label="站点点击量" aria-hidden="false"></i><span id="busuanzi_value_site_pv"></span></span><span id="busuanzi_container_site_uv"><i class="fas fa-user" aria-label="站点用户数" aria-hidden="false"></i><span id="busuanzi_value_site_uv"></span></span><span id="busuanzi_container_page_pv"><i class="far fa-file-alt"></i><span id="busuanzi_value_page_pv" aria-label="页面点击量" aria-hidden="false"></span></span></div></div><div class="footer-right"><div class="custom-info">托管于<i class="fab fa-github-alt"></i><a href="https://pages.github.com/" target="_blank">GitHub Pages</a></div><div class="powered-by">由 <a href="https://hexo.io/" target="_blank">Hexo</a> 强力驱动 | 主题 <a href="https://github.com/AlynxZhou/hexo-theme-aria/" target="_blank">ARIA</a></div></div></div></div></footer></body></html>